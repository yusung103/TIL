# JPA N+1
지연, 즉시 로딩을 곁들인.
> 1번 조회해도 되는 것을 N개 종류의 데이터들도 같이 추가로 조회하는 **N+1**.

데이터 조회시 1번만 해도 되는 것을 관련된 1,000,000개의 데이터가 있어서 1,000,001 DB 조회하게 되어 많은 양의 쿼리가 발생함과 성능저하를 일으킴.

## 📌 즉시 / 지연 로딩
`@XXToXX` 연관관계를 가진(1:N, N:1) 엔티티에서 주로 발생.

### 📎 즉시 로딩 (EAGER)
엔티티 조회시 연관관계에 있는 데이터까지 조회해 오는 기능.  
`@XXToXX(fetch = FetchType.EAGER)`으로 지정.

- join을 이용해 연관된 엔티티까지 함께 조회
- 연관관계에 있는 데이터들도 함께 불러와야 한다면 즉시로딩이 효율적
  - User와 Profile라는 엔티티가 있을 때, User를 조회할 때 마다 profile도 조회
- **N+1문제 발생**

### 📎 지연 로딩 (LAZY)
실제 해당 엔티티가 필요한 시점에 조회하는 기능.  
`@XXToXX(fetch = FetchType.LAZY)`로 지정.
- 연관된 데이터를 프록시로 조회
- 조회 대상이 영속성 컨텍스트에 있으면 실제 객체를 사용
- 연관 엔티티를 사용하는 과정에서 DB쿼리가 추가적으로 발생할 가능성 있음

지연 로딩도 N+1문제가 발생함.  
필요할 때만 연관 데이터를 가져오기 때문에 문제가 되진 않음. 그러나 하위 엔티티를 조회할 경우, 그 객체가 프록시 개체일 경우 상위 엔티티를 조회하고 하위 엔티티를 조회하는 쿼리가 나가기 때문에 N+1문제가 발생

## 해결 방법
연관관계에 대한 설정이 필요하다면 FetchType을 성능 최적화를 하기 어려운 즉시 로딩(EAGER)을 사용하는 게 아니라 지연 로딩 (LAZY) 모드로 사용을 하고 성능 최적화가 필요한 부분에서는 Fetch 조인을 사용한다.  
또한 기본적으로 Batch Size의 값을 1000 이하로 설정한다. (대부분의 DB에서 IN절의 최대 개수 값 : 1000)